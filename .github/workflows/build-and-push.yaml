name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.set-matrix.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        run: |
          set -euo pipefail
          BASE_SHA=${{ github.event.before }}
          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE_SHA" ]; then 
            BASE_SHA="HEAD^"
          fi
          
          DIFF=$(git diff --name-only $BASE_SHA ${{ github.sha }} | grep '^apps/' | cut -d/ -f2 | sort -u || true)
          
          if [ -z "$DIFF" ]; then
            echo "apps=[]" >> $GITHUB_OUTPUT
          else
            APPS_JSON=$(echo "$DIFF" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "apps=$APPS_JSON" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.apps != '[]' && needs.detect-changes.outputs.apps != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app: ${{ fromJSON(needs.detect-changes.outputs.apps) }}

    steps:
      - uses: actions/checkout@v4

      - uses: nhedger/setup-sops@v2

      - name: Decrypt and Configure OCI
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          set -euo pipefail
          
          mkdir -p secrets
          echo "$SOPS_AGE_KEY" > secrets/.sops.key
          export SOPS_AGE_KEY_FILE=$(pwd)/secrets/.sops.key
          
          sops -d --output-type json secrets/prod/secrets.yaml > secrets.json
          
          mkdir -p ~/.oci
          jq -r '.TF_VAR_private_key_content' secrets.json | tr -d '\r' > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          
          OCI_USER=$(jq -r '.TF_VAR_user_ocid' secrets.json)
          OCI_TENANCY=$(jq -r '.TF_VAR_tenancy_ocid' secrets.json)
          OCI_FINGERPRINT=$(jq -r '.TF_VAR_fingerprint' secrets.json)
          OCI_REGION=$(jq -r '.TF_VAR_region' secrets.json)
          OCI_COMPARTMENT=$(jq -r '.TF_VAR_compartment_ocid' secrets.json)
          
          echo "::add-mask::$OCI_USER"
          echo "::add-mask::$OCI_TENANCY"
          echo "::add-mask::$OCI_FINGERPRINT"

          echo "[DEFAULT]" > ~/.oci/config
          echo "user=$OCI_USER" >> ~/.oci/config
          echo "fingerprint=$OCI_FINGERPRINT" >> ~/.oci/config
          echo "tenancy=$OCI_TENANCY" >> ~/.oci/config
          echo "region=$OCI_REGION" >> ~/.oci/config
          echo "key_file=$HOME/.oci/key.pem" >> ~/.oci/config
          chmod 600 ~/.oci/config
          
          echo "OCI_COMPARTMENT_ID=$OCI_COMPARTMENT" >> $GITHUB_ENV

      - uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: "--version"
          silent: true

      - name: Resolve Vault Secrets
        id: vault_secrets
        run: |
          set -euo pipefail
          
          VAULT_SECRETS=$(oci vault secret list --compartment-id "$OCI_COMPARTMENT_ID" --all --query "data[?\"lifecycle-state\" == 'ACTIVE'].{name: \"secret-name\", id: id}")
          
          echo "build_args<<EOF_DOCKER" >> $GITHUB_OUTPUT
          
          if [ "$VAULT_SECRETS" != "[]" ] && [ -n "$VAULT_SECRETS" ]; then
            while read -r secret; do
              NAME=$(echo "$secret" | jq -r '.name')
              ID=$(echo "$secret" | jq -r '.id')
              ARG_NAME=$(echo "$NAME" | tr '-' '_' | tr '[:lower:]' '[:upper:]')
          
              BUNDLE=$(oci secrets secret-bundle get --secret-id "$ID" --stage CURRENT 2>/dev/null || true)
              if [ -n "$BUNDLE" ]; then
                VAL=$(echo "$BUNDLE" | jq -r '.data."secret-bundle-content".content' | base64 -d 2>/dev/null || true)
                if [ -n "$VAL" ]; then
                  while read -r line; do
                    echo "::add-mask::$line"
                  done <<< "$VAL"
                  echo "${ARG_NAME}=${VAL}" >> $GITHUB_OUTPUT
                fi
              fi
            done < <(echo "$VAULT_SECRETS" | jq -c '.[]')
          fi
          
          echo "SITE_URL=https://glg.fabianpiper.com" >> $GITHUB_OUTPUT
          echo "EOF_DOCKER" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: apps/${{ matrix.app }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app }}:latest
          build-args: ${{ steps.vault_secrets.outputs.build_args }}

      - name: Cleanup
        if: always()
        run: |
          rm -f secrets.json secrets/.sops.key ~/.oci/key.pem
          rm -rf secrets/ ~/.oci/