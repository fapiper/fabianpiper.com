name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.set-matrix.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        run: |
          set -euo pipefail
          BASE_SHA=${{ github.event.before }}
          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE_SHA" ]; then 
            BASE_SHA="HEAD^"
          fi
          
          DIFF=$(git diff --name-only $BASE_SHA ${{ github.sha }} | grep '^apps/' | cut -d/ -f2 | sort -u || true)
          
          if [ -z "$DIFF" ]; then
            echo "apps=[]" >> $GITHUB_OUTPUT
          else
            APPS_JSON=$(echo "$DIFF" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "apps=$APPS_JSON" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.apps != '[]' && needs.detect-changes.outputs.apps != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app: ${{ fromJSON(needs.detect-changes.outputs.apps) }}

    steps:
      - uses: actions/checkout@v4

      - uses: nhedger/setup-sops@v2

      - name: Decrypt Bootstrap Secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          set -euo pipefail
          mkdir -p secrets
          echo "$SOPS_AGE_KEY" > secrets/.sops.key
          export SOPS_AGE_KEY_FILE=$(pwd)/secrets/.sops.key
          
          sops -d --output-type dotenv secrets/prod/secrets.yaml > secrets.env
          
          while IFS='=' read -r key value; do
            [ -n "$value" ] && echo "::add-mask::${value}"
          done < secrets.env

      - name: Configure OCI CLI
        run: |
          set -euo pipefail
          set -a && source secrets.env && set +a
          
          mkdir -p ~/.oci
          printf "%s" "$TF_VAR_private_key_content" | tr -d '\r' > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=$TF_VAR_user_ocid" >> ~/.oci/config
          echo "fingerprint=$TF_VAR_fingerprint" >> ~/.oci/config
          echo "tenancy=$TF_VAR_tenancy_ocid" >> ~/.oci/config
          echo "region=$TF_VAR_region" >> ~/.oci/config
          echo "key_file=$HOME/.oci/key.pem" >> ~/.oci/config
          
          chmod 600 ~/.oci/config
          echo "OCI_COMPARTMENT_ID=$TF_VAR_compartment_ocid" >> $GITHUB_ENV

      - uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: "--version"
          silent: true

      - name: Resolve Vault Secrets
        id: vault_secrets
        run: |
          set -euo pipefail
          
          echo "Fetching secrets from OCI Vault..."
          QUERY="data[?\"lifecycle-state\" == 'ACTIVE'].{name: \"secret-name\", id: id}"
          SECRETS_JSON=$(oci vault secret list --compartment-id "$OCI_COMPARTMENT_ID" --all --query "$QUERY")
          
          if [ -z "$SECRETS_JSON" ] || [ "$SECRETS_JSON" == "[]" ]; then
            echo "::warning::No active secrets found"
            echo "build_args=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "build_args<<EOF_DOCKER" >> $GITHUB_OUTPUT
          
          while read -r secret; do
            V_NAME=$(echo "$secret" | jq -r '.name')
            V_ID=$(echo "$secret" | jq -r '.id')
          
            ARG_NAME=$(echo "$V_NAME" | tr '-' '_' | tr '[:lower:]' '[:upper:]')
          
            BUNDLE=$(oci secrets secret-bundle get --secret-id "$V_ID" --stage CURRENT 2>/dev/null || true)
            if [ -n "$BUNDLE" ]; then
              VAL=$(echo "$BUNDLE" | jq -r '.data."secret-bundle-content".content' | base64 -d 2>/dev/null || true)
              if [ -n "$VAL" ]; then
                echo "::add-mask::$VAL"
                echo "${ARG_NAME}=${VAL}" >> $GITHUB_OUTPUT
              fi
            fi
          done < <(echo "$SECRETS_JSON" | jq -c '.[]')
          echo "EOF_DOCKER" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}