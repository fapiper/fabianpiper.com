name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.set-matrix.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        run: |
          BASE_SHA=${{ github.event.before }}
          [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ] && BASE_SHA="HEAD^"
          
          DIFF=$(git diff --name-only $BASE_SHA ${{ github.sha }} | grep '^apps/' | cut -d/ -f2 | sort -u || true)
          
          if [ -z "$DIFF" ]; then
            echo "apps=[]" >> $GITHUB_OUTPUT
          else
            APPS_JSON=$(echo "$DIFF" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "apps=$APPS_JSON" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.apps != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app: ${{ fromJSON(needs.detect-changes.outputs.apps) }}

    steps:
      - uses: actions/checkout@v4

      - uses: nhedger/setup-sops@v2

      - name: Decrypt Bootstrap Secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          mkdir -p secrets
          echo "$SOPS_AGE_KEY" > secrets/.sops.key
          export SOPS_AGE_KEY_FILE=$(pwd)/secrets/.sops.key
          sops -d --output-type dotenv secrets/prod/secrets.yaml > secrets.env
          
          while IFS='=' read -r key value; do
            [ -n "$value" ] && echo "::add-mask::${value}"
          done < secrets.env

      - name: Configure OCI CLI
        run: |
          set -a && source secrets.env && set +a
          
          mkdir -p ~/.oci
          echo "$TF_VAR_private_key_content" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=$TF_VAR_user_ocid
          fingerprint=$TF_VAR_fingerprint
          tenancy=$TF_VAR_tenancy_ocid
          region=$TF_VAR_region
          key_file=$HOME/.oci/key.pem
          EOF
          
          echo "OCI_COMPARTMENT_ID=$TF_VAR_compartment_ocid" >> $GITHUB_ENV

      - uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: "--version"
          silent: true

      - name: Resolve Vault Secrets
        id: vault_secrets
        run: |
          set -euo pipefail
          
          echo "DEBUG: OCI_COMPARTMENT_ID=$OCI_COMPARTMENT_ID"
          echo "DEBUG: Testing OCI CLI authentication..."
          oci iam compartment get --compartment-id "$OCI_COMPARTMENT_ID" || echo "WARNING: Could not verify compartment access"
          
          echo "DEBUG: Fetching secrets from vault..."
          SECRETS_JSON=$(oci vault secret list \
            --compartment-id "$OCI_COMPARTMENT_ID" \
            --all \
            --lifecycle-state ACTIVE 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to list secrets"
            echo "$SECRETS_JSON"
            exit 1
          fi
          
          echo "DEBUG: Raw OCI response received"
          
          SECRETS_JSON=$(echo "$SECRETS_JSON" | jq -c '[.data[] | {name: .["secret-name"], id: .id}]' 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to parse secrets JSON"
            echo "$SECRETS_JSON"
            exit 1
          fi
          
          echo "DEBUG: Found secrets count: $(echo "$SECRETS_JSON" | jq '. | length')"
          
          if [ "$SECRETS_JSON" = "[]" ] || [ -z "$SECRETS_JSON" ]; then
            echo "::warning::No active secrets found in vault"
            echo "build_args=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          {
            echo "build_args<<EOF_BUILD_ARGS"
          
            while IFS= read -r secret; do
              VAULT_NAME=$(echo "$secret" | jq -r '.name')
              VAULT_ID=$(echo "$secret" | jq -r '.id')
          
              if [ "$VAULT_NAME" = "null" ] || [ "$VAULT_ID" = "null" ]; then
                echo "DEBUG: Skipping null secret"
                continue
              fi
          
              ARG_NAME=$(echo "$VAULT_NAME" | tr '-' '_' | tr '[:lower:]' '[:upper:]')
          
              echo "DEBUG: Processing $VAULT_NAME -> $ARG_NAME"
          
              BUNDLE=$(oci secrets secret-bundle get \
                --secret-id "$VAULT_ID" \
                --stage CURRENT 2>&1)
          
              if [ $? -ne 0 ]; then
                echo "WARNING: Failed to fetch secret $VAULT_NAME"
                echo "$BUNDLE"
                continue
              fi
          
              VALUE=$(echo "$BUNDLE" | jq -r '.data."secret-bundle-content".content' 2>/dev/null | base64 -d 2>/dev/null)
          
              if [ -n "$VALUE" ]; then
                echo "::add-mask::${VALUE}"
                echo "${ARG_NAME}=${VALUE}"
                echo "DEBUG: Successfully processed $ARG_NAME"
              else
                echo "WARNING: Empty value for $VAULT_NAME"
              fi
            done < <(echo "$SECRETS_JSON" | jq -c '.[]')
          
            echo "EOF_BUILD_ARGS"
          } >> $GITHUB_OUTPUT
          
          echo "DEBUG: Secrets resolution completed"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: apps/${{ matrix.app }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.app }}:latest
          build-args: ${{ steps.vault_secrets.outputs.build_args }}

      - name: Cleanup
        if: always()
        run: |
          rm -f secrets.env secrets/.sops.key ~/.oci/key.pem
          rm -rf secrets/ ~/.oci/