package_update: true
packages:
  - curl
  - iptables-persistent

write_files:

  - path: /etc/rancher/k3s/registries.yaml
    owner: root:root
    permissions: '0644'
    content: |
      configs:
        ghcr.io:
          auth:
            username: ${git_username}
            password: ${git_pat}

runcmd:
  # Configure iptables
  - iptables -P INPUT ACCEPT
  - iptables -P FORWARD ACCEPT
  - iptables -F INPUT
  - iptables -F FORWARD
  - netfilter-persistent save

  # Install K3s server
  - |
    curl -sfL https://get.k3s.io | sh -s - server \
      --token ${k3s_token} \
      --tls-san ${public_ip} \
      --disable traefik \
      --disable servicelb \
      --node-label role=server
