#cloud-config
package_update: true
packages:
  - curl
  - iptables-persistent

write_files:
  - path: /etc/sysctl.d/99-k3s.conf
    content: |
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
    permissions: '0644'

runcmd:
  # Enable IP forwarding immediately
  - sysctl -w net.ipv4.ip_forward=1

  # Configure iptables for NAT and forwarding (interface-agnostic)
  # Using multi-line block to keep DEFAULT_IFACE in scope
  - |
    DEFAULT_IFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')
    iptables -P INPUT ACCEPT
    iptables -P FORWARD ACCEPT
    iptables -F INPUT
    iptables -F FORWARD
    iptables -t nat -F POSTROUTING
    iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o $DEFAULT_IFACE -j MASQUERADE
    iptables -I FORWARD -s 10.0.2.0/24 -j ACCEPT
    iptables -I FORWARD -d 10.0.2.0/24 -j ACCEPT
    iptables -I INPUT -p tcp --dport 22 -j ACCEPT
    iptables -I INPUT -p tcp --dport 80 -j ACCEPT
    iptables -I INPUT -p tcp --dport 443 -j ACCEPT
    iptables -I INPUT -p tcp --dport 6443 -j ACCEPT
    iptables -I FORWARD -s 10.42.0.0/16 -d 10.42.0.0/16 -j ACCEPT
    netfilter-persistent save

  # Wait for K3s server to be ready
  - |
    until curl -k https://${server_ip}:6443; do
      echo "Waiting for K3s Server..."
      sleep 10
    done

  # Install K3s agent with ingress role
  - curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="agent --node-label role=ingress" K3S_URL=https://${server_ip}:6443 K3S_TOKEN=${k3s_token} sh -
